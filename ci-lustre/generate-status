#!/bin/bash

PATCH_DIR=~/git-big/upstream-patch-review

# Count HTML patch files
PATCH_COUNT=$(ls "$PATCH_DIR"/*_home.html 2>/dev/null | wc -l)

# Get uptime
UPTIME_INFO=$(uptime)

# Get total disk space used (excluding .git)
TOTAL_SPACE=$(du -ch --exclude=".git" "$PATCH_DIR" | grep total$ | awk '{print $1}')

# Compute space per patch (in bytes for accuracy, then format)
TOTAL_BYTES=$(du -sb --exclude=".git" "$PATCH_DIR" | awk '{print $1}')
if [ "$PATCH_COUNT" -gt 0 ]; then
    SPACE_PER_PATCH_BYTES=$((TOTAL_BYTES / PATCH_COUNT))
else
    SPACE_PER_PATCH_BYTES=0
fi

# Get max patches
ONE_GB=$((1024 * 1024 * 1024))
MAX_PATCHES=$(( ONE_GB / SPACE_PER_PATCH_BYTES ))

# Convert bytes to human-readable form
SPACE_PER_PATCH_HUMAN=$(numfmt --to=iec $SPACE_PER_PATCH_BYTES)

echo "PatchCount: $PATCH_COUNT"
echo "Uptime: $UPTIME_INFO"
echo "TotalSpace: $TOTAL_SPACE"
echo "SpacePerPatch: $SPACE_PER_PATCH_HUMAN"
echo "MaxPatches: $MAX_PATCHES"

exit 0
